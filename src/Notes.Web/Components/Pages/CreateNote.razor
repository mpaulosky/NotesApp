@page "/notes/create"
@using global::Notes.Web.Features.Notes.CreateNote
@using MediatR
@inject IMediator Mediator
@inject NavigationManager NavigationManager
@attribute [Authorize]

<PageHeadingComponent Level="1" HeaderText="@_pageTitle" />

<div class="container-card">
	<EditForm Model="@_note" OnValidSubmit="HandleValidSubmit">
		<DataAnnotationsValidator />
		<ValidationSummary class="text-red-500 mb-4" />

		<div class="mb-4">
			<label for="title" class="block text-sm font-medium text-gray-300 mb-2">Title</label>
			<InputText id="title" @bind-Value="_note.Title" class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 outline-none" />
		</div>

		<div class="mb-4">
			<label for="content" class="block text-sm font-medium text-gray-300 mb-2">Content</label>
			<InputTextArea id="content" @bind-Value="_note.Content" rows="10" class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 outline-none" />
		</div>

		@if (!string.IsNullOrEmpty(_errorMessage))
		{
			<ErrorAlertComponent Message="@_errorMessage" />
		}

		<div class="flex gap-4">
			<button type="submit" disabled="@_isSaving" class="btn-primary">
				@(_isSaving ? "Creating..." : "Create")
			</button>
			<button type="button" @onclick="Cancel" class="btn-secondary">
				Cancel
			</button>
		</div>
	</EditForm>
</div>

@code {
	[CascadingParameter]
	private Task<AuthenticationState>? AuthenticationState { get; set; }

	private const string _pageTitle = "Create Note";
	private NoteCreateModel _note = new();
	private bool _isSaving = false;
	private string? _errorMessage;
	private string _userSubject = string.Empty;

	protected override async Task OnInitializedAsync()
	{
		if (AuthenticationState is not null)
		{
			var state = await AuthenticationState;
			_userSubject = state.User.Claims
				.Where(c => c.Type.Equals(System.Security.Claims.ClaimTypes.NameIdentifier))
				.Select(c => c.Value)
				.FirstOrDefault() ?? string.Empty;
		}
	}

	private async Task HandleValidSubmit()
	{
		_isSaving = true;
		_errorMessage = null;

		try
		{
			var command = new CreateNoteCommand
			{
				Title = _note.Title,
				Content = _note.Content,
				UserSubject = _userSubject
			};

			var response = await Mediator.Send(command);

			if (response != null)
			{
				NavigationManager.NavigateTo("/notes");
			}
			else
			{
				_errorMessage = "Failed to create note.";
			}
		}
		catch (Exception ex)
		{
			_errorMessage = $"Error creating note: {ex.Message}";
		}
		finally
		{
			_isSaving = false;
		}
	}

	private void Cancel()
	{
		NavigationManager.NavigateTo("/notes");
	}

	private class NoteCreateModel
	{
		public string Title { get; set; } = string.Empty;
		public string Content { get; set; } = string.Empty;
	}
}
